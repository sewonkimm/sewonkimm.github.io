---
layout: post
title: ğŸ’Spring framework - Mybatis
date: 2020-11-01 22:13:00
author: 'SeWonKim'
categories: [Java]
tags: [jekyll, TIL, Java, web, spring, mybatis]
fullview: false
comments: true
description: Spring Mybatis ì—°ë™
---

# ëª©ì°¨

- Mybatis
- Mybatis ì‚¬ìš©ë²•
- spring mybatis

&nbsp;  
&nbsp;  
&nbsp;

---

&nbsp;  
&nbsp;  
&nbsp;

# Mybatis...?

### ê¸°ì¡´ MVC íŒ¨í„´

DAO(DBì™€ ì—°ê²°ì„ ë‹´ë‹¹í•˜ëŠ” ë¶€ë¶„)ì—ì„œëŠ” JDBCë¥¼ ì‚¬ìš©í–ˆë‹¤.

1. Driver ë¡œë”©
2. connect
3. sqlë¬¸ ì‘ì„±
4. sqlë¬¸ ì‹¤í–‰
5. connect ëŠê¸°

ì˜ ê³¼ì •ì„ ê±°ì³¤ê³ , java íŒŒì¼ ì•ˆì— sql ë¬¸ì´ ê°™ì´ ì¨ ìˆì—ˆë‹¤.

### Mybatisë¥¼ ì‚¬ìš©í•¨ìœ¼ë¡œì¨ java ì½”ë“œ ì¿¼ë¦¬ë¬¸ì„ ë¶„ë¦¬í•  ìˆ˜ ìˆë‹¤!

- Mybatisê°€ javaì™€ SQLë¬¸(ë³„ë„ì˜ íŒŒì¼ë¡œ ë¶„ë¦¬) ì‚¬ì´ì˜ ìë™ Mappingì„ ì§€ì›
- sqlë¬¸ ì‘ì„±í•˜ëŠ” ê²ƒì„ ì œì™¸í•˜ê³  ë‚˜ë¨¸ì§€ ê³¼ì •ì„ Mybatisë¥¼ ì‚¬ìš©í•´ ìë™í™” ì‹œì¼œì„œ ë©”ì†Œë“œì˜ ê¸¸ì´ë¥¼ ë§ì´ ì¤„ì¼ ìˆ˜ ìˆë‹¤.
- ìµìˆ™í•œ SQLì„ ê·¸ëŒ€ë¡œ ì´ìš©
- JDBC ì½”ë“œ ì‘ì„±ì˜ ë¶ˆí¸í•¨ì„ ì¤„ì—¬ì¤Œ
- SQLë¬¸ê³¼ java ì½”ë“œì˜ ë¶„ë¦¬
- SQL ê´€ë¦¬ ë° ê²€í† ë¥¼ ë‹¤ë¥¸ ì‚¬ëŒì—ê²Œ ë§¡ê¸¸ ìˆ˜ ìˆìŒ

&nbsp;  
&nbsp;  
&nbsp;

# Mybatis ì‚¬ìš©ë²•

> [mybatis docs](https://mybatis.org/mybatis-3/ko/index.html)

ì „ì²´ì ì¸ íë¦„  
`Controller â†” ServiceImpl â†” DaoImpl â†” sqlSession â†” DB`

### 1. pom.xmlì— ì¶”ê°€

- mybatisì™€ mybatis-spring ì¶”ê°€
- maven ì„ ì‚¬ìš©í•˜ë¯€ë¡œ pom.xmlì— mybatis ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì¶”ê°€í•œë‹¤.

<details>
<summary>pom.xmlì— mybatis ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶€ë¶„</summary>
<div markdown="1">

```xml
<!-- https://mvnrepository.com/artifact/org.mybatis/mybatis -->
<dependency>
	<groupId>org.mybatis</groupId>
	<artifactId>mybatis</artifactId>
	<version>3.5.3</version>
</dependency>
<!-- https://mvnrepository.com/artifact/org.mybatis/mybatis-spring -->
<dependency>
	<groupId>org.mybatis</groupId>
	<artifactId>mybatis-spring</artifactId>
	<version>2.0.3</version>
</dependency>
```

</div>
</details>

&nbsp;  
&nbsp;

### 2. Mapper ì„¤ì • xml

<details>
<summary>ìƒì„¸ ë‚´ìš© í™•ì¸</summary>
<div markdown="1">

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-config.dtd">

<configuration>

    <!-- ë³€ìˆ˜ë“¤ì„ propertiesì—ì„œ ê°€ì ¸ì˜¨ë‹¤. ë³€ìˆ˜ ì§ì ‘ ì…ë ¥í•˜ë ¤ë©´ ì´ê±° ì‚¬ìš©ì•ˆí•´ë„ ë¬´ë°© -->
	<properties resource="dbinfo.properties"/>

    <!-- type aliasë¡œ mapperì—ì„œ ì½”ë“œ ê¸¸ì´ë¥¼ ì¤„ì´ê¸°! ì‚¬ìš©ì•ˆí•´ë„ ë¬´ë°© -->
	<typeAliases>
		<typeAlias type="com.ssafy.guestbook.model.GuestBookDto" alias="guestbook" />
		<typeAlias type="com.ssafy.guestbook.model.MemberDto" alias="member" />
	</typeAliases>

    <!-- DB ì—°ê²° -->
	<environments default="development">
        <environment id="development">
            <transactionManager type="JDBC"/>
            <dataSource type="POOLED">
                <property name="driver" value="${driver}"/>
                <property name="url" value="${url}"/>
                <property name="username" value="${dbid}"/>
                <property name="password" value="${dbpwd}"/>
            </dataSource>
        </environment>
    </environments>

    <!-- ì—°ê²°í•  SQLë¬¸ì´ ì–´ë””ìˆëŠ”ì§€ ì•Œë ¤ì¤€ë‹¤ -->
    <mappers>
		<mapper resource="member.xml" />
		<mapper resource="guestbook.xml" />
	</mappers>
</configuration>
```

</div>
</details>

&nbsp;  
&nbsp;

dbinfo.properties íŒŒì¼ ë‚´ìš©ì€

```
driver=com.mysql.cj.jdbc.Driver
url=jdbc:mysql://localhost:3306/ssafyweb?serverTimezone=UTC&useUniCode=yes&characterEncoding=UTF-8
dbid=ssafy
dbpwd=ssafy
```

ì´ëŸ°ì‹ìœ¼ë¡œ ì‚¬ìš©í•  ë³€ìˆ˜ë“¤ì„ ì €ì¥í•´ë†“ì€ ê²ƒ

&nbsp;  
&nbsp;  
&nbsp;

### 3. SqlSessionFactory ë¹Œë“œ

- SqlSessionFactoryëŠ” sqlë¬¸ì„ java ì½”ë“œì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ë°”ê¿”ì£¼ëŠ” ì—­í• ì„ í•œë‹¤.

<details>
<summary>SqlMapConfig.java</summary>
<div markdown="1">

```java
public class SqlMapConfig {

private static SqlSessionFactory factory;

	static {
		try {
			String resource = "mybatis-config.xml";
			Reader reader = Resources.getResourceAsReader(resource);
			factory = new SqlSessionFactoryBuilder().build(reader);
		} catch (IOException e) {
			e.printStackTrace();
		}
	}

	public static SqlSession getSqlSession() {
		return factory.openSession(true);
	}

}
```

</div>
</details>

&nbsp;  
&nbsp;  
&nbsp;

### 4. ì¿¼ë¦¬ë¬¸ ì‘ì„± xml

<details>
<summary>query.xml</summary>
<div markdown="1">

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.guestbook.model.dao.UserDao">

	<select id="login" parameterType="map" resultType="member">
		select username, userid, email
		from ssafy_member
		where userid = #{userid} and userpwd = #{userpwd}
	</select>

</mapper>
```

</div>
</details>

ì´ ë•Œ DOCTYPE ì— `mapper`ì„ì— ì£¼ì˜!  
config íŒŒì¼ì€ `config`ë¼ê³  ë˜ì–´ìˆë‹¤.

- select, insert, update, delete
- id
- parameterType
- resultType (selectë§Œ ìˆìŒ)
- íŒŒë¼ë¯¸í„° í‘œê¸°ëŠ” `#{íŒŒë¼ë¯¸í„°}` í˜•íƒœë¡œ
- if, foreach ë“±ì„ ì‚¬ìš©í•´ ë™ì  sql ì‘ì„±ì´ ê°€ëŠ¥

&nbsp;  
&nbsp;  
&nbsp;

### 5. DAO

- ì•„ê¹Œ ë¹Œë“œí•œ factoryì—ì„œ getSqlSession ë©”ì†Œë“œë¥¼ í†µí•´ SqlSessionì„ ì–»ì–´ì˜¨ í›„ ì¿¼ë¦¬ ì‹¤í–‰
- `@Repository` ëŠ” ë°ì´í„° ì ‘ê·¼ ê°ì²´ë¥¼ beanìœ¼ë¡œ ë“±ë¡í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ” annotation
- `@Autowired` ë¥¼ í†µí•´ ì‚¬ìš©í•˜ë ¤ëŠ” Mapper interfaceë¥¼ ë°ì´í„° ì ‘ê·¼ ê°ì²´ì™€ ì˜ì¡´ê´€ê³„ ì„¤ì •

<details>
<summary>UserDaoImpl.java</summary>
<div markdown="1">

```java
@Repository
public class UserDaoImpl implements UserDao {

	@Override
	public MemberDto login(Map<String, String> map) throws SQLException {
		try(SqlSession sqlSession = SqlMapConfig.getSqlSession()) {
			return sqlSession.selectOne("com.ssafy.guestbook.model.dao.UserDao.login", map);
		}
	}

}
```

</div>
</details>

### ğŸ‡ì •ë¦¬

mapper.xml + properties íŒŒì¼ ğŸ‘‰ `sqlConfig.xml` ğŸ‘‰ `sqlSessionFactory` ğŸ‘‰ sqlSession

- mapper.xml íŒŒì¼; ì¿¼ë¦¬ë¬¸ì„ ê°€ì§€ê³  ìˆë‹¤.
- config.xml íŒŒì¼; DB ì ‘ì† urlì´ë‚˜ alias, mapping íŒŒì¼ì˜ ê²½ë¡œ ë“± í™˜ê²½ ì •ë³´ ì„¤ì •
- sqlSessionFactoryBuilder; config íŒŒì¼ì„ ë°”íƒ•ìœ¼ë¡œ sqlSessionFactoryë¥¼ ìƒì„±
- sqlSessionFactory; sqlSession ìƒì„±
- sqlSession; ğŸ‡í•µì‹¬ğŸ‡ SQL ì‹¤í–‰

&nbsp;  
&nbsp;  
&nbsp;

## Spring Mybatis

1. spring lagacy project ìƒì„±
2. facets ë³€ê²½
3. pom.xml: mybatis-spring ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€
4. web.xml: í”„ë¡œì íŠ¸ì— ëŒ€í•œ ì „ì²´ì ì¸ ì„¤ì •. tomcatì´ ì½ì–´ë“¤ì´ê³  spring containerê°€ ì¼ë°˜ì ì¸ ê°ì²´ë¥¼ ë§Œë“ ë‹¤. ğŸ‘‰ servlet-context.xml(controller ê´€ë ¨ ì„¤ì •, DispatcherServlet ê¹¡í†µì„ ë§Œë“¤ê³  ê±°ê¸°ì— ë„£ëŠ”ë‹¤) & root-context.xml(service, dao ê´€ë ¨ ì„¤ì •)
5. mybatis-config.xml
6. sql ë¬¸ ì‘ì„±
7. Data ì ‘ê·¼ ê°ì²´ êµ¬í˜„; daoImpl ì‚¬ìš©í•˜ì§€ ì•Šê³  dao interfaceë§Œ ì‚¬ìš©

&nbsp;  
&nbsp;

### pom.xml

- mysql
- mybatis
- mybatis-spring
- commons-dbcp; connection poll ê´€ë ¨
- jackson-databind; rest api ê´€ë ¨, json í˜•ì‹ ì‚¬ìš©

<details>
<summary>pom.xml ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶€ë¶„</summary>
<div markdown="1">

```xml
        <!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java -->
		<dependency>
			<groupId>mysql</groupId>
			<artifactId>mysql-connector-java</artifactId>
			<version>8.0.20</version>
		</dependency>

		<!-- https://mvnrepository.com/artifact/org.mybatis/mybatis -->
		<dependency>
			<groupId>org.mybatis</groupId>
			<artifactId>mybatis</artifactId>
			<version>3.5.3</version>
		</dependency>
		<!-- https://mvnrepository.com/artifact/org.mybatis/mybatis-spring -->
		<dependency>
			<groupId>org.mybatis</groupId>
			<artifactId>mybatis-spring</artifactId>
			<version>2.0.3</version>
		</dependency>
		<!-- https://mvnrepository.com/artifact/commons-dbcp/commons-dbcp -->
		<dependency>
			<groupId>commons-dbcp</groupId>
			<artifactId>commons-dbcp</artifactId>
			<version>1.4</version>
		</dependency>

		<!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-databind -->
		<dependency>
			<groupId>com.fasterxml.jackson.core</groupId>
			<artifactId>jackson-databind</artifactId>
			<version>2.11.0</version>
		</dependency>
```

</div>
</details>

&nbsp;  
&nbsp;

### root-context.xml

- mybatisëŠ” webì´ ì•„ë‹ˆë¼ dao ê´€ë ¨ ì„¤ì •ì´ë¯€ë¡œ root-context.xmlì— ì‘ì„±í•œë‹¤.
- **SqlSessionFactory ê°ì²´ ìƒì„±**ì„ ìœ„í•´ SqlSessionFactoryBeanë¥¼ ë¹ˆìœ¼ë¡œ ë“±ë¡
- SqlSessionFactoryBeanë¥¼ ë¹ˆìœ¼ë¡œ ë“±ë¡ì‹œ **ì‚¬ìš©í•  ë°ì´í„° ì†ŒìŠ¤(query.xml)ì™€ mybatis ì„¤ì •íŒŒì¼(mybatis-config.xml) ì •ë³´**ê°€ í•„ìš”
- transaction manager ì„¤ì •

&nbsp;  
&nbsp;

<details>
<summary>root-context.xml</summary>
<div markdown="1">

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:tx="http://www.springframework.org/schema/tx"
	xsi:schemaLocation="http://www.springframework.org/schema/beans https://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-4.3.xsd">

	<!-- Root Context: defines shared resources visible to all other web components -->
    <!-- 1. JndiObjectFactoryBeanë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•´ì„œ DataSource ì„¤ì • (META-INF ì¶”ê°€) -->
	<bean id="dataSource" class="org.springframework.jndi.JndiObjectFactoryBean">
		<property name="jndiName" value="java:comp/env/jdbc/ssafy"/>
	</bean>

    <!-- 2. SqlSessionFactoryBean ìƒì„± -->
	<bean id="sqlSessionFactoryBean" class="org.mybatis.spring.SqlSessionFactoryBean">
		<property name="dataSource" ref="dataSource"/>

        <!-- ì„¤ì • íŒŒì¼ (ìë°” ê²½ë¡œì— ìˆëŠ” ì• ë“¤ì€ classpathë¥¼ ë¶™ì—¬ì¤€ë‹¤) -->
		<property name="configLocation" value="classpath:mybatis-config.xml"/>

        <!-- mapper íŒŒì¼ -->
		<property name="mapperLocations">
			<list>
				<value>classpath:member.xml</value>
				<value>classpath:guestbook.xml</value>
			</list>
		</property>
	</bean>


	<!-- 3. SqlSessionTemplateìœ¼ë¡œ sqlSessionìƒì„± -->
	<bean id="sqlSession" class="org.mybatis.spring.SqlSessionTemplate">
		<constructor-arg ref="sqlSessionFactoryBean"/>
	</bean>

    <!-- 4. transaction ê´€ë¦¬ -->
	<bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
		<property name="dataSource" ref="dataSource" />
	</bean>
	<tx:annotation-driven transaction-manager="transactionManager"/>

</beans>
```

</div>
</details>

&nbsp;  
&nbsp;

### mybatis-config.xml

- object ì™€ sqlì„ mappping ì‹œì¼œì£¼ëŠ” ë¶€ë¶„
- DBì ‘ì† ì •ë³´ë‚˜ Mapper ê´€ë ¨ ì„¤ì •ì€ spring beanìœ¼ë¡œ ë“±ë¡í•˜ì—¬ ê´€ë¦¬í•˜ë¯€ë¡œ springì—ì„œ ê´€ë¦¬í•˜ì§€ ì•ŠëŠ” ì¼ë¶€ ì •ë³´ë§Œ ì„¤ì •

<details>
<summary>mybatis-config.xml</summary>
<div markdown="1">

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-config.dtd">

<configuration>
	<typeAliases>
		<typeAlias type="com.ssafy.guestbook.model.GuestBookDto" alias="guestbook" />
		<typeAlias type="com.ssafy.guestbook.model.MemberDto" alias="member" />
	</typeAliases>
</configuration>

```

</div>
</details>

&nbsp;  
&nbsp;  
&nbsp;

### SQLë¬¸ ì‘ì„±

<details>
<summary>mybatis-config.xml</summary>
<div markdown="1">

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.guestbook.model.mapper.UserDao">

	<select id="login" parameterType="map" resultType="member">
		select username, userid, email
		from ssafy_member
		where userid = #{userid} and userpwd = #{userpwd}
	</select>

</mapper>
```

</div>
</details>

&nbsp;  
&nbsp;

### Data ì ‘ê·¼ ê°ì²´ êµ¬í˜„

- DaoImpl êµ¬í˜„ì´ í•„ìš” ì—†ìŒ!

```java
public interface UserDao {
	public MemberDto login(Map<String, String> map) throws SQLException;
}
```
